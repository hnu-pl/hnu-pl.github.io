---
layout: post
title: WSL2로 Haskell 노트북 환경 구성
categories:
- Haskell
feature_image: "https://picsum.photos/id/872/1300/200"
---

순수 함수형 언어인 하스켈(Haskell)이라는 멋진 언어가 있고
Haskell을 배워보면 함수형 프로그래밍의 개념을 잡기에 좋더라는
글이 인터넷 여기저기에 떠도는 것을 본 사람들도 있을 것이다.
그런데 프로그래밍을 많이 해보지 않았고 특히 윈도우즈 이외의
운영체제와 친하지 않은 사람이 주변에 하스켈 프로그래밍 경험이
있는 사람에게 도움을 받지 않고 처음 혼자서 접근하기가 그렇게 쉽지 않다.
요즘 인공지능 및 데이터 사이언스(빅데이터 등)에 많이 쓰여서 많은 사람들이
관심을 가지고 배우려 하는 파이썬(Python)의 경우와 비교해 보면 특히 대비가 된다.
인공지능 및 데이터 사이언스를 위한 공개 소프트웨어 패키지를 한데 모아
설치하기 좋게 만들어 놓은 [Anaconda](https://www.anaconda.com/)를
윈도우즈 10에[^1] 설치하기만 하면 기본 프로그램으로 딸려나오는
[주피터(Jupyter)](https://jupyter.org/)를 구동해 곧바로 웹브라우저에서
안에서 파이썬 코드를 실행해 가며 편집할 수 있는 노트북 환경을 활용할 수 있다.
최근에는 구글의 [CoLab](https://colab.research.google.com/)처럼 같이 설치할 필요도 없이
웹브라우저로 인터넷에 접속해 구글 아이디로 로그인만 하면 즉시 주피터 노트북 환경을 무료로 사용할 수도 있다.

이렇게 파이썬을 시작으로 대중화된 주피터 노트북 시스템은 다른 프로그래밍 언어도 *커널*이라는
형식으로 연동할 수 있게 발전해 20개가 넘는 프로그래밍 언어를 주피터 노트북 환경에서 구동할 수 있다.
그 중 하스켈을 주피터 노트북 환경에서 구동할 목적으로 만든 [IHaskell](https://github.com/gibiansky/IHaskell) 커널이
있으며 그 실행 화면은 아래와 같다.

![ihaskell-notebook.png](https://raw.githubusercontent.com/gibiansky/IHaskell/master/images/ihaskell-notebook.png)

참고로 앞서 언급한 Anaconda를 통해 하스켈로 작성하는 프로젝트를 관리하는 [stack](https://www.haskellstack.org/)이라는
프로그램을 설치할 수도 있지만, 이건 명령창에 텍스트를 입력하고 설정파일을 직접 구성해야 하는 매우 개발자스러운 물건이다.
하스켈로 소프트웨어 프로젝트를 진행한다거나 전통적인 텍스트 환경과 자신이 선호하는 에디터가 이미 있는 사람은
하스켈의 표준적인 개발툴인 stack을 직접 활용해도 무방하다. 이 글은 그런 것에 익숙치 않은 분들을 위해
조금이라도 더 친절한 환경을 활용할 수 있는 방법을 안내하려는 글이다.

하지만 안내가 따로 필요하다는 것 자체가
그냥 윈도우즈 인스톨러 한방으로 처리될 수 있는 수준이 아니라는 뜻이다. 그 이유는 IHaskell 프로젝트 홈페이지에서도
나와 있듯 프로세스-간-통신 구현의 기술적인 문제로 윈도우즈 환경을 직접 지원하지 않기 때문이다. 쉽게 이야기자하면
윈도우즈 바이너리로 IHaskell을 소스 컴파일해 윈도우즈 바이너리 커널을 만들 수는 있지만 그 커널 실행파일이
막상 정상적으로 실행되지는 않는다는 뜻이다. 하지만 주피터는 서버 프로그램이므로 가상화 환경이 발달한 요즘에는
리눅스 가상머신으로 주피터 서버를 구동시키고 웹브라우저만 직접 윈도우즈에서 실행해 활용하는 것이
개인용 컴퓨터로도 얼마든지 가능하다. 그렇기 때문에 이러한 환경을 구성하기 위해서는 WSL2 설치,
WSL2로 리눅스 설치, 리눅스 쉘 명령어로 리눅스 배포판 패키지를 설치/설정/실행하는 과정에 대한
최소한의 이해가 필요하므로 이에 대해 간단히 안내하고자 한다. 그래도 마이크로소프트에서
윈도우즈와 연동을 고려하여 직접 만들어 제공하는 가상환경인 WSL2를 이용하면 배경지식이
적더라도 이러한 환경설정 작업을 좀더 수월하게 따라해 볼 수 있게 되었다.

## WSL2 설치
안타깝지만 아직 공식 배포가 아닌 개발자를 위한 프리릴리즈에만 제공되는 기능이다 보니 MS에서 WSL2 설치 등에 대해 제공하는 공식 문서,
특히 [한국어 문서](https://docs.microsoft.com/ko-kr/windows/wsl/wsl2-install)의 상태는 이 글을 작성하는 시점에서 그리 좋지 않다.
그냥 자동번역을 돌린 정도의 수준인 듯 하다. 그래도 영문으로 관련 내용을 검색하면 꽤 자세히 나오는 문서나 유투브 영상 등이 있기는 하고
한국어 블로그 중에도 [나름 자세히 정리해 놓은 글](https://www.lesstif.com/pages/viewpage.action?pageId=71401661)이[^2] 있다.

일단 예전에 WSL을 사용하지 않다가 WSL2를 처음으로 사용하는 경우가 오히려 덜 번거롭기 때문에 그런 경우를 기준으로 설명하자면
대략 아래와 같은 과정을 거치면 WSL2를 사용할 수 있다.
 1. 윈도우즈 10의 '설정' 프로그램에서 "업데이트 및 보안 > 윈도우즈 참가자 프로그램"에서
    마이크로소프트 계정을 연동하여 윈도우즈 참가자 프로그램 활성화
 1. 윈도우즈 참가자 프로그램이 활성화되면 "참가자 설정 선택"에서 '초기' 선택
 1. "업데이트 및 보안 > Windows 업데이트"에서 '업데이트 확인'으로 업데이트 설치.
     여기서 기존 윈도우즈 정식 배포판 업데이트나 보안 업데이트 등 이외에 prerelease 관련 업데이트가 진행이 되면 WSL2를 이용할 준비가 된다.
     prerelease의 용량이 꽤 되기 때문에 다운로드도 어느 정도 시간이 걸리고 몇번에 걸친 재부팅이 일어나게 될 것이다.
 1. 업데이트가 정상적으로 다 된 다음에는 '설정'이 아니라 '제어판' 프로그램을 검색하여 실행하고
    "제어판 > 프로그램 > 프로그램 및 기능 > Windows 기능 켜기/끄기"에서 **Linux용 윈도우즈 하위 시스템**을 선택하여 활성화한다. 역시 다시 한번 재부팅이 필요하다.
 1. 이 과정은 필요없을지도 모르는데 그래도 혹시 모르니 윈도우즈 명령창(`cmd.exe`)을 실행하고 `wsl --set-default-version 2` 명령을 실행해 준다.
    실행시켜서 손해날 것은 없다. 이 명령은 기존에 WSL을 사용하던 경우 앞으로 설치하는 리눅스 가상환경은 기본적으로 WSL2를 사용하도록 설정하는 것이다.
 1. 'Microsoft Store' 프로그램에서 적절한 리눅스 배포판을 설치한다. 설치 후에 해당 배포판을 최초로 실행시키면 리눅스 계정(id)과 패스워드를 설정하게 된다.

이제부터 WSL2로 Ubuntu LTS 18.04를 마이크로소프트 스토어를 통해 설치하여 최초 실행에서
리눅스 계정 및 패스워드 설정까지 정상적으로 이루어진 상태라고 가정하고 진행하도록 하겠다.

## Docker 설치 및 하스켈 노트북 실행
인터넷에 정상적으로 연결된 상태에서 아래 명령으로 도커를 설치하고 자기 리눅스 계정을 도커를 활용할 수 있는 그룹에 추가한다.
```bash
sudo apt-get -y update
sudo apt-get -y install docker.io
sudo adduser 자기리눅스아이디 docker
```
새로 그룹에 추가한 다음에는 창을 닫고 다시 리눅스 쉘을 새로 실행하는 것이 더 확실하다. 

원래 창은 닫고 새로 실행한 리눅스 쉘에서 다음 명령어로 도커 서비스를 활성화한다.
```bash
sudo service docker start
```
도커 서비스가 성공적으로 활성화되었다면 아래 명령으로 IHaskell 환경이 설정된 도커 이미지를 실행한다.
최초로 실행할 때는 로컬 시스템에 도커 이미지가 없으므로 인터넷에서 받아오며 이후 실행부터는 받아왔던 이미지를 실행하게 될 것이다.
```
docker run --rm -p 8888:8888 -v $PWD:/home/jovyan/pwd --env JUPYTER_TOKEN=x --name ihaskell_notebook crosscompass/ihaskell-notebook:latest
```
위 명령[^3]이 성공적으로 실행되었다는 것은, 윈도우즈 안에 있는 WSL2 가상머신 환경에 설치된 리눅스
안에 있는 도커라는 샌드박스 환경에서, IHaskell 커널이 설치된 주피터 서버가 구동되었다는 뜻이다.
위 명령에서 `-v $PWD:/home/jovyan/pwd` 옵션은 리눅스의 현재 디렉토리(`$PWD`)와 도커 이미지 환경 안의
`/home/jovyan/pwd` 디렉토리를 연동하겠다는 뜻이다. 도커는 샌드박스 환경이므로
실행을 마치고 나면 데이타가 보관되지 않고 모래성처럼 없어져 버리는데
`/home/jovyan/pwd` 디렉토리는 도커 환경 밖의 `$PWD`에 해당하는 디렉토리,
즉 현재 현재 명령을 실행하는 도커 외부의 리눅스 디렉토리를 그대로 사용하겠다는 뜻이다.
그 외에 [위의 하스켈 노트북 도커 이미지](https://github.com/jamesdbrock/ihaskell-notebook)를
더 간편하게 활용할 수 있도록 정리한 내용은 다음 기회에 [다른 글](/haskell/2019/07/22/ihaskell-pwd/)을 통해 이야기하기로 하겠다.

이제 서버를 구동한 리눅스 쉘 창은 그대로 두고 새로 웹브라우저를 실행하기 위한 리눅스 쉘 창을 하나 더 띄우도록 하자.
윈도우즈 명령창(`cmd.exe`)이 아니라 WSL2로 구동하는 리눅스 쉘을 하나 더 띄우라는 뜻이다. 이유는 곧 설명될 것이다.

이제는 적절한 주소로 웹브라우저를 통해 주피터 서버에 접속하면 된다. 그런데 이전 버전 WSL도 그렇고 WSL2도 그렇고
아이피 주소가 자주 바뀐다. 가상머신 환경으로 많이 사용하는 VirtualBox의 경우 꼭 필요한 경우가 아니면 한개의
가상머신만 반복적으로 실행할 경우 같은 ip 주소를 유지하는데 반해 WSL2는 그렇지가 않고 정말 유동적으로
리눅스를 부팅할 때마다 잘 변한다. 그래서 `ip address` 명령으로 나오는 `eth0` 디바이스의 ip 주소를 찾아서
그 주소의 8888 포트로 접속해야 한다. 이것을 매번 명령어로 찾는다는 것은 번거로우므로 bash 쉘 스크립트로
웹 브라우저에 적절한 주소를 찾아 넘겨줄 수 있다. 일반적인 경로에 설치된 구글 크롬 브라우저를 기준으로 하겠다.
```
"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe" $(ip addr show dev eth0 | grep 'inet ' | sed 's/.*inet //' | cut -f1 -d'/'):8888
```
위 명령을 WSL2로 실행되는 새로운 리눅스 쉘 창에서 실행하면 현재 실행중인 리눅스 가상머신의 내부 ip주소를 얻어와 주피터가 실행되고 있는 8888 포트에 접속하게 될 것이다. 처음 접속하면 토큰을 입력해 로그인하라고 나올 것인데 거기에는 주피터 서버를 구동했던 명령의 `JUPYTER_TOKEN` 다음에 나오는 x를 입력하면 된다.

위 명령을 살펴보면 가상머신에서 돌아가는 게스트 OS인 리눅스에서 호스트 OS인 윈도우즈에 설치된 프로그램을 명령어로 실행시키고 있다는 것을 알게 된다. 바로 이런 점이 WSL2가 기존의 가상머신 소프트웨어에서는 (열심히 설정을 하면 가능할 수도 있지만) 기본 설정으로는 잘 제공할 수 없었던 가상머신 안의 리눅스와 외부 윈도우즈 기능과의 연동을 마이크로소프트가 직접 기본 설정으로 제공하고 있음을 보여준다.

[^1]: 참고로 윈도우즈 8은 이제 오래 된 운영체제라 특히나 개발도구의 경우 알게 모르게 짜증나는 버그가 발생할 수도 있음에 주의
[^2]: 이 블로그 저자는 파워쉘(PowerShell)에 익숙하다보니 GUI를 통해서 설정할 수 있는 것도 파워쉘에서 직접 해버린 경우도 있다
[^3]: docker 명령어에서 `--rm` 옵션은 꼭 필요하지는 않다. 관련 도커 이미지 프로젝트 페이지 예시에서 사용하는 옵션을 그대로 가져왔을 뿐이다. 참고로 `--rm`은 실행이 종료되면 컨테이너 정보를 깔끔하게 삭제해 버리는 옵션이다. 자주 사용할 이미지라면 `--rm` 옵션 없이 실행하는 것이 다시 실행할 때 등록한 이름으로 재실행할 수 있어 편리할 것이다.
